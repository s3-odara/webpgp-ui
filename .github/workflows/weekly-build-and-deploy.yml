name: Weekly build and deploy

on:
  schedule:
    - cron: "0 18 * * 0"
  workflow_dispatch:
  push:
    branches:
      - master

concurrency:
  group: site-deploy
  cancel-in-progress: true

permissions:
  contents: read

env:
  OPENPGPJS_SIGNER_FPRS: |
    twiss:72E33AE81300E553BC4EEDEFCB064A128FA90686
    larabr:DDEBA5D26F64DC406368799F2A4BEC40729185DD

  BROTLI_REGEX: '.*\.(htm|html|txt|text|asc|js|mjs|css|json|xml|svg|map|webmanifest)$'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: write
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 24

      - name: Install brotli
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y brotli

      - name: Fetch latest openpgpjs release tag
        id: release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          tag=$(gh api repos/openpgpjs/openpgpjs/releases/latest --jq .tag_name)
          if [ -z "$tag" ] || [ "$tag" = "null" ]; then
            echo "Failed to resolve latest tag" >&2
            exit 1
          fi
          ver=${tag#v}
          echo "tag=$tag" >> "$GITHUB_OUTPUT"
          echo "version=$ver" >> "$GITHUB_OUTPUT"

      - name: Download source and build bundle
        env:
          OPENPGPJS_TAG: ${{ steps.release.outputs.tag }}
          OPENPGPJS_VERSION: ${{ steps.release.outputs.version }}
        run: scripts/ci/download-source-and-build-bundle.sh

      - name: Update vendor bundle in site tree
        run: |
          set -euo pipefail
          mkdir -p site/vendor
          cp build_artifact/openpgp.min.mjs site/vendor/openpgp.min.mjs
          cp build_artifact/openpgp.version.txt site/vendor/openpgp.version.txt

      - name: Prepare deploy trees (plain + __br)
        run: scripts/ci/prepare-deploy-trees.sh

      - name: Upload artifacts (site trees + brotli list)
        uses: actions/upload-artifact@v6
        with:
          name: site-deploy
          path: |
            build_site_plain
            build_site__br
            brotli_file_list.txt
          if-no-files-found: error

  deploy:
    runs-on: ubuntu-latest
    needs: build
    permissions:
      contents: read
      actions: read
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v7
        with:
          name: site-deploy
          path: deploy_artifact

      - name: Sync uncompressed tree to Cloudflare R2 (baseline)
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: auto
          AWS_EC2_METADATA_DISABLED: "true"
          BUCKET_NAME: ${{ secrets.BUCKET_NAME }}
          ENDPOINT_URL: ${{ secrets.ENDPOINT_URL }}
        run: |
          set -euo pipefail
          aws s3 sync deploy_artifact/build_site_plain "s3://$BUCKET_NAME" \
            --endpoint-url "$ENDPOINT_URL" --delete

      - name: Sync brotli objects under __br/ with Content-Encoding br
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: auto
          AWS_EC2_METADATA_DISABLED: "true"
          BUCKET_NAME: ${{ secrets.BUCKET_NAME }}
          ENDPOINT_URL: ${{ secrets.ENDPOINT_URL }}
        run: |
          set -euo pipefail
          aws s3 sync deploy_artifact/build_site__br "s3://$BUCKET_NAME/__br" \
            --endpoint-url "$ENDPOINT_URL" \
            --content-encoding br \
            --delete
