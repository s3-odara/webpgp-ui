name: Weekly build and deploy

on:
  schedule:
    - cron: "0 18 * * 0"
  workflow_dispatch:
  push:
    branches:
      - master

permissions:
  contents: read

env:
  OPENPGPJS_SIGNER_FPRS: |
    twiss:72E33AE81300E553BC4EEDEFCB064A128FA90686
    larabr:DDEBA5D26F64DC406368799F2A4BEC40729185DD

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Fetch latest openpgpjs release tag
        id: release
        run: |
          set -euo pipefail
          tag=$(curl -sL https://api.github.com/repos/openpgpjs/openpgpjs/releases/latest | jq -r .tag_name)
          if [ -z "$tag" ] || [ "$tag" = "null" ]; then
            echo "Failed to resolve latest tag" >&2
            exit 1
          fi
          ver=${tag#v}
          echo "tag=$tag" >> "$GITHUB_OUTPUT"
          echo "version=$ver" >> "$GITHUB_OUTPUT"

      - name: Download source and build bundle
        run: |
          set -euo pipefail
          tag="${{ steps.release.outputs.tag }}"

          export GNUPGHOME="$RUNNER_TEMP/gnupg"
          mkdir -p "$GNUPGHOME"
          chmod 700 "$GNUPGHOME"

          while IFS= read -r entry; do
            [ -z "$entry" ] && continue
            username=${entry%%:*}
            fpr=${entry#*:}
            if [ -z "$username" ] || [ -z "$fpr" ]; then
              echo "Invalid OPENPGPJS_SIGNER_FPRS entry: $entry" >&2
              exit 1
            fi
            if ! printf '%s' "$fpr" | grep -Eq '^[0-9A-Fa-f]{40}$'; then
              echo "Invalid fingerprint format for $username: $fpr" >&2
              exit 1
            fi
            keyfile="$RUNNER_TEMP/${username}.gpg"
            curl -fsSL "https://github.com/${username}.gpg" \
              | sed 's/-----END PGP PUBLIC KEY BLOCK-----/-----END PGP PUBLIC KEY BLOCK-----\n/g' \
              > "$keyfile"
            gpg --batch --import "$keyfile"
            if ! gpg --batch --with-colons --fingerprint \
              | awk -F: '$1=="fpr"{print $10}' \
              | grep -Fx "$fpr" >/dev/null; then
              echo "Expected fingerprint not found for $username: $fpr" >&2
              exit 1
            fi
          done <<EOF_FPRS
          ${{ env.OPENPGPJS_SIGNER_FPRS }}
          EOF_FPRS

          git init openpgpjs-src
          cd openpgpjs-src
          git remote add origin https://github.com/openpgpjs/openpgpjs.git
          git fetch --depth=1 origin "refs/tags/${tag}:refs/tags/${tag}"
          git -c gpg.program=gpg verify-tag "${tag}"
          git checkout -q "${tag}"

          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi
          npm audit signatures
          npm test

          cd ..
          mkdir -p build_artifact
          if [ ! -f "openpgpjs-src/dist/openpgp.min.mjs" ]; then
            echo "dist/openpgp.min.mjs not found after build" >&2
            exit 1
          fi
          cp "openpgpjs-src/dist/openpgp.min.mjs" build_artifact/openpgp.min.mjs
          printf '%s\n' "${{ steps.release.outputs.version }}" > build_artifact/openpgp.version.txt

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: openpgp-dist
          path: |
            build_artifact/openpgp.min.mjs
            build_artifact/openpgp.version.txt
          if-no-files-found: error

  deploy:
    runs-on: ubuntu-latest
    needs: build
    permissions:
      contents: read
      actions: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: openpgp-dist
          path: build_artifact

      - name: Update vendor bundle
        run: |
          set -euo pipefail
          mkdir -p site/vendor
          cp build_artifact/openpgp.min.mjs site/vendor/openpgp.min.mjs
          cp build_artifact/openpgp.version.txt site/vendor/openpgp.version.txt

      - name: Sync to Cloudflare R2
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: auto
          AWS_EC2_METADATA_DISABLED: "true"
          R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
          R2_BUCKET: ${{ secrets.R2_BUCKET }}
          R2_ENDPOINT: https://${{ secrets.R2_ACCOUNT_ID }}.r2.cloudflarestorage.com
        run: |
          set -euo pipefail
          aws s3 sync site "s3://$R2_BUCKET" --endpoint-url "$R2_ENDPOINT" --delete
